- name: Post-update webhook notification (optional)
  hosts: localhost
  gather_facts: false

  vars:
    webhook_url: ""                       # via -e setzen; leer => skip
    webhook_method_default: "POST"
    message_default: "Update completed"

    # Headers als Dict (uri erwartet Dict). Content-Type wird bei body_format: json
    # automatisch gesetzt – du kannst hier zusätzliche Header ergänzen.
    webhook_headers_default: {}

  tasks:
    - name: Skip if webhook_url not provided
      ansible.builtin.debug:
        msg: "No webhook_url provided; skipping"
      when: (webhook_url | default('')) | length == 0

    - name: Send webhook (JSON) via uri
      ansible.builtin.uri:
        url: "{{ webhook_url }}"
        method: "{{ webhook_method | default(webhook_method_default) }}"
        headers: "{{ webhook_headers | default(webhook_headers_default) }}"
        body_format: json
        body:
          host: "{{ lookup('pipe','hostname -f') }}"
          message: "{{ message | default(message_default) }}"
          time: "{{ lookup('pipe','date -Is') }}"
        status_code: [200,201,202,204]
        return_content: false
        timeout: 20
        validate_certs: true
      when: (webhook_url | default('')) | length > 0
      changed_when: true
