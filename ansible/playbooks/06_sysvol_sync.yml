---
# Play 1: CT-Node-Facts laden
- name: "Load CT node facts"
  hosts: localhost
  gather_facts: false
  tasks:
    - include_tasks: includes/find_ct_nodes.yml

# Play 2: SYSVOL Sync (DC A -> DC B)
- name: "SYSVOL Sync (DC A -> DC B)"
  hosts: localhost
  gather_facts: false
  vars:
    # Quelle ist „Primary“
    dc_a: { ctid: 100, hn: "zmb-ad",      ip: "192.168.100.241" }
    # Ziel ist „Join“
    dc_b: { ctid: 101, hn: "zmb-ad-join", ip: "192.168.100.242" }
    sysvol_path: "/var/lib/samba/sysvol"
    dry_run: true
  tasks:
    - name: "Build ct_map"
      set_fact:
        ct_map:
          "100": "{{ ct100_node | default(inventory_hostname, true) | default('localhost', true) }}"
          "101": "{{ ct101_node | default(inventory_hostname, true) | default('localhost', true) }}"

    - name: "Quelle/Ziel Variablen anzeigen"
      ansible.builtin.debug:
        msg:
          - "SRC: {{ dc_a.hn }} (CT {{ dc_a.ctid }}, IP {{ dc_a.ip }})"
          - "DST: {{ dc_b.hn }} (CT {{ dc_b.ctid }}, IP {{ dc_b.ip }})"
          - "SYSVOL: {{ sysvol_path }}, dry_run={{ dry_run }}"

    - name: "Prüfen, ob Quelle läuft"
      ansible.builtin.command: >
        pct status {{ dc_a.ctid }}
      delegate_to: "{{ ct_map[dc_a.ctid|string] }}"
      changed_when: false
      failed_when: false

    - name: "Prüfen, ob Ziel läuft"
      ansible.builtin.command: >
        pct status {{ dc_b.ctid }}
      delegate_to: "{{ ct_map[dc_b.ctid|string] }}"
      changed_when: false
      failed_when: false

    # Dry-Run: nur anzeigen
    - name: "SYSVOL Vergleich (Dry-Run simuliert)"
      ansible.builtin.shell: >
        echo "Would sync {{ sysvol_path }} from CT{{ dc_a.ctid }} -> CT{{ dc_b.ctid }} (dry_run={{ dry_run }})"
      args:
        executable: /bin/bash
      delegate_to: "{{ inventory_hostname }}"
      changed_when: false
      when: dry_run | bool

    #########################################################################
    # SYSVOL Pull: CT101 zieht von CT100 (rsync über SSH)
    #########################################################################
    - name: "Ensure rsync + ssh-client on CT101"
      ansible.builtin.shell: |
        set -e
        pct exec 101 -- bash -lc '
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -y
          apt-get install -y rsync openssh-client'
      args: { executable: /bin/bash }
      delegate_to: "{{ ct_map['101'] }}"
      changed_when: false
      failed_when: false

    - name: "Create SSH key on CT101 if absent"
      ansible.builtin.shell: |
        pct exec 101 -- bash -lc '
          umask 077
          mkdir -p /root/.ssh
          [ -f /root/.ssh/id_ed25519 ] || ssh-keygen -t ed25519 -N "" -f /root/.ssh/id_ed25519'
      args: { executable: /bin/bash }
      delegate_to: "{{ ct_map['101'] }}"
      changed_when: false
      failed_when: false

    - name: "Read CT101 pubkey"
      ansible.builtin.command: >
        pct exec 101 -- bash -lc 'cat /root/.ssh/id_ed25519.pub'
      delegate_to: "{{ ct_map['101'] }}"
      register: ct101_pub
      changed_when: false

    - name: "Authorize CT101 pubkey on CT100"
      ansible.builtin.shell: |
        pct exec 100 -- bash -lc '
          umask 077
          mkdir -p /root/.ssh
          touch /root/.ssh/authorized_keys
          grep -qxF "{{ ct101_pub.stdout | trim }}" /root/.ssh/authorized_keys || echo "{{ ct101_pub.stdout | trim }}" >> /root/.ssh/authorized_keys'
      args: { executable: /bin/bash }
      delegate_to: "{{ ct_map['100'] }}"
      changed_when: false
      failed_when: false

    - name: "Populate known_hosts on CT101"
      ansible.builtin.shell: |
        pct exec 101 -- bash -lc '
          mkdir -p /root/.ssh
          touch /root/.ssh/known_hosts
          ssh-keygen -F {{ dc_a.ip }} >/dev/null 2>&1 || ssh-keyscan -H {{ dc_a.ip }} >> /root/.ssh/known_hosts
          chmod 600 /root/.ssh/known_hosts'
      args: { executable: /bin/bash }
      delegate_to: "{{ ct_map['101'] }}"
      changed_when: false
      failed_when: false

    - name: "Ensure destination sysvol dir exists on CT101"
      ansible.builtin.shell: |
        pct exec 101 -- bash -lc 'mkdir -p {{ sysvol_path | default("/var/lib/samba/sysvol") }}'
      args: { executable: /bin/bash }
      delegate_to: "{{ ct_map['101'] }}"
      changed_when: false
      failed_when: false

    # ---- Dry-Run (Vorschau) ----
    - name: "SYSVOL Pull (DRY-RUN): CT101 <- CT100"
      when: dry_run | default(true) | bool
      ansible.builtin.shell: |
        pct exec 101 -- bash -lc '
          rsync -aHAXx --delete --numeric-ids --dry-run \
            root@{{ dc_a.ip }}:{{ sysvol_path | default("/var/lib/samba/sysvol") }}/ \
            {{ sysvol_path | default("/var/lib/samba/sysvol") }}/'
      args: { executable: /bin/bash }
      delegate_to: "{{ ct_map['101'] }}"
      changed_when: false
      failed_when: false

    # ---- Echter Sync ----
    - name: "SYSVOL Pull (REAL): CT101 <- CT100"
      when: not (dry_run | default(true) | bool)
      ansible.builtin.shell: |
        pct exec 101 -- bash -lc '
          rsync -aHAXx --delete --numeric-ids \
            root@{{ dc_a.ip }}:{{ sysvol_path | default("/var/lib/samba/sysvol") }}/ \
            {{ sysvol_path | default("/var/lib/samba/sysvol") }}/'
      args: { executable: /bin/bash }
      delegate_to: "{{ ct_map['101'] }}"
      changed_when: true
      failed_when: false
