---
# 06_sysvol_sync.yml
#
# SYSVOL Sync von DC A (CT100) -> DC B (CT101)
# Dry-Run mit:  ansible-playbook 06_sysvol_sync.yml
# Real-Run mit: ansible-playbook 06_sysvol_sync.yml -e "sysvol_dry_run=false"

- name: Load CT node facts
  hosts: localhost
  gather_facts: false
  tasks:
    - include_tasks: includes/find_ct_nodes.yml

- name: SYSVOL Sync (DC A -> DC B)
  hosts: localhost
  gather_facts: false
  vars:
    # Standardwerte – können bei Bedarf via -e überschrieben werden
    src_ct_id: 100
    dst_ct_id: 101
    src_ip: "192.168.100.241"
    dst_ip: "192.168.100.242"
    sysvol_path: "/var/lib/samba/sysvol"

  tasks:
    #################################################################
    # ct_map bauen (IDs -> Node, Conf)
    #################################################################
    - name: Build ct_map
      ansible.builtin.set_fact:
        _ct_map: >-
          {{
            [
              {'id': 100, 'node': (ct100_node | default('')), 'conf': (ct100_conf | default(''))},
              {'id': 101, 'node': (ct101_node | default('')), 'conf': (ct101_conf | default(''))}
            ]
          }}

    #################################################################
    # Dry-Run Effektivwert bestimmen (Extra-Var respektieren)
    #################################################################
    - name: Effektiven Dry-Run-Wert berechnen (Extra-Var respektieren)
      ansible.builtin.set_fact:
        sysvol_dry_run_effective: "{{ (sysvol_dry_run | default(true)) | bool }}"

    - name: Quelle/Ziel Variablen anzeigen
      ansible.builtin.debug:
        msg:
          - "SRC: zmb-ad (CT {{ src_ct_id }}, IP {{ src_ip }})"
          - "DST: zmb-ad-join (CT {{ dst_ct_id }}, IP {{ dst_ip }})"
          - "SYSVOL: {{ sysvol_path }}, dry_run={{ sysvol_dry_run_effective | ternary('True','False') }}"

    #################################################################
    # Läuft Quelle/Ziel?
    #################################################################
    - name: "Prüfen, ob Quelle (CT {{ src_ct_id }}) läuft"
      delegate_to: "{{ (_ct_map | selectattr('id','equalto',src_ct_id) | first).node }}"
      ansible.builtin.shell: |
        set -euo pipefail
        pct status {{ src_ct_id }} | grep -q "status: running"
      register: _src_running
      changed_when: false

    - name: "Prüfen, ob Ziel (CT {{ dst_ct_id }}) läuft"
      delegate_to: "{{ (_ct_map | selectattr('id','equalto',dst_ct_id) | first).node }}"
      ansible.builtin.shell: |
        set -euo pipefail
        pct status {{ dst_ct_id }} | grep -q "status: running"
      register: _dst_running
      changed_when: false

    #################################################################
    # rsync/ssh-client sicherstellen (Ziel + Quelle)
    #################################################################
    - name: "Ensure rsync + ssh-client present on CT {{ dst_ct_id }}"
      delegate_to: "{{ (_ct_map | selectattr('id','equalto',dst_ct_id) | first).node }}"
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ dst_ct_id }} -- bash -lc '
          if ! command -v rsync >/dev/null 2>&1 || ! dpkg -s openssh-client >/dev/null 2>&1; then
            apt-get update -y
            apt-get install -y --no-install-recommends rsync openssh-client
          fi
        '
      register: _rsync_install_dst
      changed_when: _rsync_install_dst.stdout is search("install") or _rsync_install_dst.stdout is search("Setting up")

    - name: "Ensure rsync present on source CT {{ src_ct_id }}"
      delegate_to: "{{ (_ct_map | selectattr('id','equalto',src_ct_id) | first).node }}"
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ src_ct_id }} -- bash -lc '
          if ! command -v rsync >/dev/null 2>&1; then
            apt-get update -y
            apt-get install -y --no-install-recommends rsync
          fi
        '
      register: _rsync_install_src
      changed_when: _rsync_install_src.stdout is search("install") or _rsync_install_src.stdout is search("Setting up")

    #################################################################
    # SSH-Trust: Key im Ziel erzeugen, auf Quelle autorisieren
    #################################################################
    - name: "Create SSH key on CT {{ dst_ct_id }} if absent"
      delegate_to: "{{ (_ct_map | selectattr('id','equalto',dst_ct_id) | first).node }}"
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ dst_ct_id }} -- bash -lc '
          mkdir -p /root/.ssh
          chmod 700 /root/.ssh
          if [ ! -f /root/.ssh/id_ed25519 ]; then
            ssh-keygen -t ed25519 -N "" -f /root/.ssh/id_ed25519
          fi
        '
      register: _create_key_dst
      changed_when: "'Generating public/private ed25519 key pair' in _create_key_dst.stdout"

    - name: "Read CT {{ dst_ct_id }} pubkey"
      delegate_to: "{{ (_ct_map | selectattr('id','equalto',dst_ct_id) | first).node }}"
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ dst_ct_id }} -- bash -lc 'cat /root/.ssh/id_ed25519.pub'
      register: _dst_pubkey
      changed_when: false

    - name: "Authorize CT {{ dst_ct_id }} pubkey on CT {{ src_ct_id }}"
      delegate_to: "{{ (_ct_map | selectattr('id','equalto',src_ct_id) | first).node }}"
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ src_ct_id }} -- bash -lc '
          mkdir -p /root/.ssh
          chmod 700 /root/.ssh
          touch /root/.ssh/authorized_keys
          chmod 600 /root/.ssh/authorized_keys
          if ! grep -Fxq "{{ _dst_pubkey.stdout | trim }}" /root/.ssh/authorized_keys; then
            echo "{{ _dst_pubkey.stdout | trim }}" >> /root/.ssh/authorized_keys
          fi
        '
      changed_when: false

    - name: "Populate known_hosts on CT {{ dst_ct_id }}"
      delegate_to: "{{ (_ct_map | selectattr('id','equalto',dst_ct_id) | first).node }}"
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ dst_ct_id }} -- bash -lc '
          mkdir -p /root/.ssh
          chmod 700 /root/.ssh
          ssh-keyscan -T 5 {{ src_ip }} >> /root/.ssh/known_hosts 2>/dev/null || true
          sort -u /root/.ssh/known_hosts -o /root/.ssh/known_hosts || true
        '
      changed_when: false

    #################################################################
    # Zielpfad sicherstellen
    #################################################################
    - name: "Ensure destination sysvol dir exists on CT {{ dst_ct_id }}"
      delegate_to: "{{ (_ct_map | selectattr('id','equalto',dst_ct_id) | first).node }}"
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ dst_ct_id }} -- bash -lc 'mkdir -p {{ sysvol_path }}'
      changed_when: false

    #################################################################
    # DRY-RUN (nur wenn gewünscht)
    #################################################################
    - name: "SYSVOL Pull (DRY-RUN): CT {{ dst_ct_id }} <- CT {{ src_ct_id }}"
      when: sysvol_dry_run_effective | bool
      delegate_to: "{{ (_ct_map | selectattr('id','equalto',dst_ct_id) | first).node }}"
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ dst_ct_id }} -- bash -lc '
          rsync -av --delete -e "ssh -o StrictHostKeyChecking=no" \
            root@{{ src_ip }}:{{ sysvol_path }}/ {{ sysvol_path }}/
        '
      register: _dry_run
      changed_when: false

    #################################################################
    # REAL-Sync (wenn nicht Dry-Run)
    #################################################################
    - name: "SYSVOL Pull (REAL): CT {{ dst_ct_id }} <- CT {{ src_ct_id }}"
      when: not (sysvol_dry_run_effective | bool)
      delegate_to: "{{ (_ct_map | selectattr('id','equalto',dst_ct_id) | first).node }}"
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ dst_ct_id }} -- bash -lc '
          rsync -a --delete -e "ssh -o StrictHostKeyChecking=no" \
            root@{{ src_ip }}:{{ sysvol_path }}/ {{ sysvol_path }}/
        '
      register: _real_run
      changed_when: true
