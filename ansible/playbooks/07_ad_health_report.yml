- name: AD Health Report
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../group_vars/all.yml

  vars:
    report_dir: "reports"

  tasks:
    - name: Ensure reports directory exists
      ansible.builtin.file:
        path: "{{ report_dir }}"
        state: directory
        mode: "0755"

    - name: Collect health info from each DC
      ansible.builtin.shell: |
        pct exec {{ item.ctid }} -- bash -lc '
          echo "### {{ item.hn }} (CT {{ item.ctid }})"
          echo
          echo "#### DNS recursion test"
          dig +time=2 +retry=1 @127.0.0.1 deb.debian.org A | sed -n "1,30p"
          echo
          echo "#### SRV records _ldap._tcp"
          host -t SRV _ldap._tcp.{{ domain }} || true
          echo
          echo "#### wbinfo trust"
          wbinfo -t || true
          echo
          echo "#### drs showrepl"
          samba-tool drs showrepl || true
          echo
          echo "#### samba-ad-dc status (last 100 lines)"
          journalctl -u samba-ad-dc -n 100 --no-pager || true
          echo
        '
      loop: ["{{ dc_a }}", "{{ dc_b }}"]
      register: health
      changed_when: false

    - name: Build Markdown report content
      ansible.builtin.set_fact:
        report_content: |
          # AD Health Report ({{ domain }})
          Generated: {{ '%Y-%m-%d %H:%M:%S' | strftime() }}

          {% for r in health.results %}
          {{ r.stdout }}
          {% endfor %}

    - name: Write report to file
      ansible.builtin.copy:
        dest: "{{ report_dir }}/ad-health-{{ '%Y%m%d-%H%M%S' | strftime() }}.md"
        content: "{{ report_content }}"
        mode: "0644"
