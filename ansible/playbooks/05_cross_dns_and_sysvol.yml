
- name: Cross-DNS & SYSVOL Health (AD-DCs)
  hosts: localhost
  gather_facts: false

  # Erwartet werden folgende Variablen in group_vars/all.yml:
  # - domain: "amazonistan.intranet"
  # - dns_fallback:
  #     nameservers: ["1.1.1.1", "9.9.9.9"]
  #     search: "amazonistan.intranet"
  # - dc_a / dc_b mit ctid, hn, ip (werden unten zu dcs zusammengeführt)

  vars:
    # aus dc_a/dc_b eine Schleifenstruktur bauen
    dcs:
      - "{{ dc_a }}"
      - "{{ dc_b }}"

  pre_tasks:
    - name: Zeige verwendete Domain & DNS-Fallback
      debug:
        msg:
          - "Domain: {{ domain }}"
          - "Fallback NS: {{ dns_fallback.nameservers | default([]) | join(', ') }}"
          - "Search: {{ dns_fallback.search | default(domain) }}"

  tasks:
    # ------------------------------------------------------------------------------------------
    # 0) Sicherstellen, dass beide CTs laufen
    # ------------------------------------------------------------------------------------------
    - name: "Stelle sicher, dass beide DC-Container laufen"
      shell: |
        if ! pct status {{ item.ctid }} | grep -q running; then
          pct start {{ item.ctid }}
        fi
      args:
        executable: /bin/bash
      loop: "{{ dcs }}"
      changed_when: "'running' not in (lookup('pipe', 'pct status ' ~ item.ctid) | default(''))"

    # ------------------------------------------------------------------------------------------
    # 1) Fallback-DNS + Suchdomäne robust direkt am CT setzen (wirkt in /etc/resolv.conf)
    #    -> nutzt die Proxmox-API (pct set), vermeidet Argument-Parsing-Fehler per Komma
    # ------------------------------------------------------------------------------------------
    - name: "Setze Fallback-DNS & Suchdomäne per pct set"
      shell: >
        pct set {{ item.ctid }}
        -nameserver {{ dns_fallback.nameservers | join(',') }}
        -searchdomain {{ dns_fallback.search | default(domain) }}
      args:
        executable: /bin/bash
      loop: "{{ dcs }}"
      changed_when: false

    - name: "Reboote CTs, damit DNS/Resolver sicher greift"
      shell: "pct reboot {{ item.ctid }}"
      args:
        executable: /bin/bash
      loop: "{{ dcs }}"
      changed_when: true

    # ------------------------------------------------------------------------------------------
    # 2) Warte bis Internet-DNS-Auflösung in beiden CTs funktioniert
    # ------------------------------------------------------------------------------------------
    - name: "Warte auf funktionierende Internetauflösung in beiden CTs (getent deb.debian.org)"
      shell: "pct exec {{ item.ctid }} -- bash -lc 'getent hosts deb.debian.org'"
      args:
        executable: /bin/bash
      register: dns_wait
      retries: 15
      delay: 2
      until: dns_wait.rc == 0
      loop: "{{ dcs }}"

    # ------------------------------------------------------------------------------------------
    # 3) Cross-DNS-Checks: jeder DC fragt explizit beim jeweils anderen DC an
    # ------------------------------------------------------------------------------------------
    - name: "Bestimme Peer-Reihenfolge (A->B, B->A) für Cross-DNS"
      set_fact:
        cross_pairs:
          - src: "{{ dc_a }}"
            dst: "{{ dc_b }}"
          - src: "{{ dc_b }}"
            dst: "{{ dc_a }}"

    - name: "Cross-DNS: Internet-Name via PEER-DNS (dig @peer deb.debian.org A)"
      shell: >
        pct exec {{ item.src.ctid }} -- bash -lc
        "dig +time=2 +retry=1 @{{ item.dst.ip }} deb.debian.org A | sed -n '1,30p'"
      args:
        executable: /bin/bash
      register: dig_peer
      failed_when: false
      loop: "{{ cross_pairs }}"

    - name: "Cross-DNS: AD-SRV via PEER-DNS (host -t SRV _ldap._tcp.DOMAIN @peer)"
      shell: >
        pct exec {{ item.src.ctid }} -- bash -lc
        "host -t SRV _ldap._tcp.{{ domain }} {{ item.dst.ip }}"
      args:
        executable: /bin/bash
      register: srv_peer
      failed_when: false
      loop: "{{ cross_pairs }}"

    # ------------------------------------------------------------------------------------------
    # 4) SYSVOL-Prüfung
    # ------------------------------------------------------------------------------------------
    - name: "SYSVOL vorhanden?"
      shell: >
        pct exec {{ item.ctid }} -- bash -lc
        "test -d /var/lib/samba/sysvol/{{ domain }} && echo OK || echo MISSING"
      args:
        executable: /bin/bash
      register: sysvol_check
      loop: "{{ dcs }}"
      changed_when: false

    # ------------------------------------------------------------------------------------------
    # 5) Zusammenfassung ausgeben
    # ------------------------------------------------------------------------------------------
    - name: "Cross-DNS & SYSVOL Zusammenfassung"
      debug:
        msg:
          - "dig @peer Ergebnisse:"
          - "{{ dig_peer.results | map(attribute='stdout') | list }}"
          - "SRV @peer Ergebnisse:"
          - "{{ srv_peer.results | map(attribute='stdout') | list }}"
          - "SYSVOL Checks:"
          - >-
            {{
              dict(dcs | map(attribute='hn') |
              list | zip(sysvol_check.results | map(attribute='stdout') | list))
            }}




# ------------------------------------------------------------
# Ensure Samba DNS forwarders on both DCs (idempotent helper)
# ------------------------------------------------------------
- name: Ensure Samba DNS forwarders on DC A and B
  hosts: localhost
  gather_facts: false
  vars:
    dc_list:
      - "{{ dc_a }}"
      - "{{ dc_b }}"
    forwarder_line: "dns forwarder = 1.1.1.1 9.9.9.9"

  tasks:
    - name: Ensure forwarder line present in smb.conf and restart samba-ad-dc if changed
      shell: >
        pct exec {{ item.ctid }} -- bash -lc '
          set -e
          fline="{{ forwarder_line }}"
          if ! grep -Eq "^[[:space:]]*dns[[:space:]]+forwarder[[:space:]]*=[[:space:]]*1\.1\.1\.1[[:space:]]+9\.9\.9\.9" /etc/samba/smb.conf; then
            awk -v ins="$fline" "
              BEGIN{done=0}
              /^\[global\]/{print; print ins; done=1; next}
              {print}
              END{if(!done) print \"[global]\n\" ins}
            " /etc/samba/smb.conf > /tmp/smb.conf.new
            mv /tmp/smb.conf.new /etc/samba/smb.conf
            systemctl restart samba-ad-dc
            echo updated
          else
            echo ok
          fi
        '
      args:
        executable: /bin/bash
      loop: "{{ dc_list }}"
      register: fwd_set

    - name: Show forwarder outcome per DC
      debug:
        msg: "{{ item.item.hn }} -> {{ item.stdout | default('') }}"
      loop: "{{ fwd_set.results }}"
