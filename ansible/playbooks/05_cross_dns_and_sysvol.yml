# Playbook 05: Cross-DNS & SYSVOL Health (AD-DCs)
---
- name: Cross-DNS & SYSVOL Health (AD-DCs)
  hosts: pve3
  gather_facts: false
  vars:
    dc_a: { ctid: 100, hn: "zmb-ad",      ip: "192.168.100.241" }
    dc_b: { ctid: 101, hn: "zmb-ad-join", ip: "192.168.100.242" }
    dns_fallback: "1.1.1.1"

  tasks:
    - name: Stelle sicher, dass beide DC-Container laufen
      ansible.builtin.shell: |
        pct start {{ item.ctid }} || true
      loop: [ "{{ dc_a }}", "{{ dc_b }}" ]

    - name: Warte auf funktionierende Internetauflösung in beiden CTs
      ansible.builtin.shell: |
        pct exec {{ item.ctid }} -- bash -lc 'getent hosts deb.debian.org'
      register: dns_bootstrap
      retries: 15
      delay: 2
      until: dns_bootstrap.rc == 0
      loop: [ "{{ dc_a }}", "{{ dc_b }}" ]

    # --- Prüfen, ob systemd-resolved im jeweiligen CT vorhanden ist ---
    - name: Prüfe, ob systemd-resolved im CT existiert
      ansible.builtin.shell: |
        pct exec {{ item.ctid }} -- bash -lc '
          if command -v systemctl >/dev/null 2>&1 && systemctl list-unit-files | grep -q "^systemd-resolved.service"; then
            echo yes
          else
            echo no
          fi
        '
      register: has_resolved
      changed_when: false
      loop: [ "{{ dc_a }}", "{{ dc_b }}" ]
      loop_control:
        label: "{{ item.ctid }}"

    # --- Variante 1: mit systemd-resolved ---
    - name: Cross-DNS via systemd-resolved (DC-A → DC-B)
      ansible.builtin.shell: |
        pct exec {{ dc_a.ctid }} -- bash -lc '
          set -e
          mkdir -p /etc/systemd
          cat > /etc/systemd/resolved.conf <<EOF
[Resolve]
DNS={{ dc_b.ip }} {{ dns_fallback }}
Domains=~{{ dc_a.hn }}.amazonistan.intranet amazonistan.intranet
Cache=yes
DNSStubListener=yes
EOF
          ln -snf /run/systemd/resolve/resolv.conf /etc/resolv.conf || true
          systemctl restart systemd-resolved
        '
      when: has_resolved.results[0].stdout.strip() == "yes"

    - name: Cross-DNS via systemd-resolved (DC-B → DC-A)
      ansible.builtin.shell: |
        pct exec {{ dc_b.ctid }} -- bash -lc '
          set -e
          mkdir -p /etc/systemd
          cat > /etc/systemd/resolved.conf <<EOF
[Resolve]
DNS={{ dc_a.ip }} {{ dns_fallback }}
Domains=~{{ dc_b.hn }}.amazonistan.intranet amazonistan.intranet
Cache=yes
DNSStubListener=yes
EOF
          ln -snf /run/systemd/resolve/resolv.conf /etc/resolv.conf || true
          systemctl restart systemd-resolved
        '
      when: has_resolved.results[1].stdout.strip() == "yes"

    # --- Variante 2: ohne systemd-resolved (echte resolv.conf) ---
    - name: Cross-DNS ohne systemd-resolved (DC-A → DC-B) – /etc/resolv.conf als Datei
      ansible.builtin.shell: |
        pct exec {{ dc_a.ctid }} -- bash -lc '
          set -e
          chattr -i /etc/resolv.conf 2>/dev/null || true
          [ -L /etc/resolv.conf ] && rm -f /etc/resolv.conf || true
          install -m 0644 /dev/null /etc/resolv.conf
          cat > /etc/resolv.conf <<EOF
search amazonistan.intranet
nameserver {{ dc_b.ip }}
nameserver {{ dns_fallback }}
EOF
        '
      when: has_resolved.results[0].stdout.strip() == "no"

    - name: Cross-DNS ohne systemd-resolved (DC-B → DC-A) – /etc/resolv.conf als Datei
      ansible.builtin.shell: |
        pct exec {{ dc_b.ctid }} -- bash -lc '
          set -e
          chattr -i /etc/resolv.conf 2>/dev/null || true
          [ -L /etc/resolv.conf ] && rm -f /etc/resolv.conf || true
          install -m 0644 /dev/null /etc/resolv.conf
          cat > /etc/resolv.conf <<EOF
search amazonistan.intranet
nameserver {{ dc_a.ip }}
nameserver {{ dns_fallback }}
EOF
        '
      when: has_resolved.results[1].stdout.strip() == "no"

    - name: Prüfe Internetauflösung nach Cross-DNS
      ansible.builtin.shell: |
        pct exec {{ item.ctid }} -- bash -lc 'getent hosts deb.debian.org'
      register: dns_after
      retries: 10
      delay: 2
      until: dns_after.rc == 0
      loop: [ "{{ dc_a }}", "{{ dc_b }}" ]
