---
# Play 1: CT-Node-Facts laden
- name: Load CT node facts
  hosts: localhost
  gather_facts: false
  tasks:
    - include_tasks: includes/find_ct_nodes.yml

# Play 2: Cross-DNS & SYSVOL Health
- name: Cross-DNS & SYSVOL Health (AD-DCs)
  hosts: localhost
  gather_facts: false

  vars:
    dc_a: { ctid: 100, hn: "zmb-ad",      ip: "192.168.100.241", storage: "raidpool" }
    dc_b: { ctid: 101, hn: "zmb-ad-join", ip: "192.168.100.242", storage: "ceph-rbd" }
    fallback_dns: "1.1.1.1, 9.9.9.9"
    searchdom: "amazonistan.intranet"

  tasks:
    - name: Build ct_map
      set_fact:
        ct_map:
          "100": "{{ ct100_node | default(inventory_hostname, true) | default('localhost', true) }}"
          "101": "{{ ct101_node | default(inventory_hostname, true) | default('localhost', true) }}"

    - name: Zeige verwendete Domain & DNS-Fallback
      debug:
        msg:
          - "Domain: {{ searchdom }}"
          - "Fallback NS: {{ fallback_dns }}"
          - "Search: {{ searchdom }}"

    - name: Stelle sicher, dass beide DC-Container laufen
      ansible.builtin.shell: |
        if ! pct status {{ item.ctid }} | grep -q running; then
          pct start {{ item.ctid }}
        fi
      args: { executable: /bin/bash }
      loop:
        - "{{ dc_a }}"
        - "{{ dc_b }}"
      loop_control: { label: "CT {{ item.ctid }}" }
      delegate_to: "{{ ct_map[item.ctid|string] }}"
      changed_when: false
      failed_when: false

    - name: Setze Fallback-DNS & Suchdom√§ne per pct set (beide CTs)
      ansible.builtin.shell: |
        set -e
        pct set {{ item.ctid }} -searchdomain {{ searchdom }} -nameserver {{ fallback_dns }}
      args: { executable: /bin/bash }
      loop:
        - "{{ dc_a }}"
        - "{{ dc_b }}"
      loop_control: { label: "CT {{ item.ctid }}" }
      delegate_to: "{{ ct_map[item.ctid|string] }}"
      changed_when: false
      failed_when: false

    - name: Reboote CTs, damit DNS/Resolver sicher greift
      ansible.builtin.shell: "pct reboot {{ item.ctid }}"
      args: { executable: /bin/bash }
      loop:
        - "{{ dc_a }}"
        - "{{ dc_b }}"
      loop_control: { label: "CT {{ item.ctid }}" }
      delegate_to: "{{ ct_map[item.ctid|string] }}"
      changed_when: false
      failed_when: false
