---
# Play 1: CT-Node-Facts laden
- name: Load CT node facts
  hosts: localhost
  gather_facts: false
  tasks:
    - include_tasks: includes/find_ct_nodes.yml

# Play 2: Debian 13 Upgrade & Checks
- name: Upgrade & Health-Checks für Zamba-DCs (Debian 13 "Trixie")
  hosts: localhost
  gather_facts: false

  vars:
    dc_ctids: [100, 101]

  tasks:
    - name: Build ct_map
      set_fact:
        ct_map:
          "100": "{{ ct100_node | default(inventory_hostname, true) | default('localhost', true) }}"
          "101": "{{ ct101_node | default(inventory_hostname, true) | default('localhost', true) }}"

    - name: Erzeuge Log-Verzeichnis in jedem CT
      ansible.builtin.command: >
        pct exec {{ item }} -- bash -lc 'mkdir -p /root/ad-upgrade-logs'
      loop: "{{ dc_ctids }}"
      delegate_to: "{{ ct_map[item|string] }}"
      changed_when: false
      failed_when: false

    # --- Beispielhafte Upgrade-Schritte (idempotent & unkritisch) ---
    - name: Apt Update
      ansible.builtin.command: >
        pct exec {{ item }} -- bash -lc 'apt-get update -y'
      loop: "{{ dc_ctids }}"
      delegate_to: "{{ ct_map[item|string] }}"
      changed_when: false
      failed_when: false

    - name: Dist-Upgrade (noninteractive, nur Demo)
      ansible.builtin.command: >
        pct exec {{ item }} -- bash -lc 'DEBIAN_FRONTEND=noninteractive apt-get -y dist-upgrade'
      loop: "{{ dc_ctids }}"
      delegate_to: "{{ ct_map[item|string] }}"
      changed_when: false
      failed_when: false

    - name: Prüfe samba-ad-dc Status (Tail)
      ansible.builtin.command: >
        pct exec {{ item }} -- bash -lc 'journalctl -u samba-ad-dc -n 30 --no-pager || true'
      loop: "{{ dc_ctids }}"
      delegate_to: "{{ ct_map[item|string] }}"
      changed_when: false
      failed_when: false
