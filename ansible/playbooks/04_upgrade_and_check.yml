# Playbook 04: Debian-13-Upgrade & Samba/DC Health-Checks (robust)
---
- name: Upgrade & Health-Checks für Zamba-DCs (Debian 13 "Trixie")
  hosts: pve3
  gather_facts: false
  vars:
    dc_ctids: [100, 101]
    # während des Bootstraps (erstes apt update) nutzen wir einen externen Resolver
    bootstrap_resolver: "1.1.1.1"
    ad_domain: "amazonistan.intranet"

  tasks:
    - name: Erzeuge Log-Verzeichnis in jedem CT
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc 'mkdir -p /root/ad-upgrade-logs'
      loop: "{{ dc_ctids }}"

    - name: Stelle sicher, dass die Container laufen
      ansible.builtin.shell: |
        pct start {{ item }} || true
      loop: "{{ dc_ctids }}"

# --- Bootstrap-DNS: temporäre /etc/resolv.conf setzen (symlink-safe) ---
    - name: Setze temporäre /etc/resolv.conf (Bootstrap) in jedem CT
      shell: >
        pct exec {{ item }} -- bash -lc 'set -e;
        if [ -L /etc/resolv.conf ] || [ ! -e /etc/resolv.conf ]; then rm -f /etc/resolv.conf; install -m 644 /dev/null /etc/resolv.conf; fi;
        printf "search {{ domain }}\n" > /etc/resolv.conf;
        {% for ns in dns_fallback %}
        printf "nameserver {{ ns }}\n" >> /etc/resolv.conf;
        {% endfor %}
        cat /etc/resolv.conf'
      args:
        executable: /bin/bash
      loop: "{{ dc_ctids }}"

    - name: Warte auf Netzwerk im CT (DNS-Auflösung extern)
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc 'getent hosts deb.debian.org'
      register: netcheck
      retries: 20
      delay: 3
      until: netcheck.rc == 0
      loop: "{{ dc_ctids }}"

    # --- Upgrade auf Debian 13 (falls noch nicht) ---
    - name: Setze trixie-Sources (falls nötig)
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc "release=$(cut -d. -f1 /etc/debian_version); \
        if [ \"$release\" != \"13\" ]; then \
          sed -i 's/bookworm/trixie/g' /etc/apt/sources.list /etc/apt/sources.list.d/*.list 2>/dev/null || true; \
        fi"
      loop: "{{ dc_ctids }}"

    - name: Preseed libc6 restart question (avoid prompt)
      shell: >
        pct exec {{ item }} -- bash -lc
        "printf 'libc6 libraries/restart-without-asking boolean true\n' | debconf-set-selections"
      args:
        executable: /bin/bash
      loop: "{{ dc_ctids }}"

    - name: apt update & dist-upgrade (non-interactive, lock-aware)
      shell: >
        pct exec {{ item }} -- bash -lc 'export DEBIAN_FRONTEND=noninteractive; export NEEDRESTART_MODE=a;
        printf "libc6 libraries/restart-without-asking boolean true\n" | debconf-set-selections;
        apt-get -o DPkg::Lock::Timeout=600 update &&
        dpkg --configure -a --force-confdef --force-confold || true &&
        apt-get -y -o DPkg::Lock::Timeout=600 -o Dpkg::Options::=--force-confdef -o Dpkg::Options::=--force-confold dist-upgrade'
      args:
        executable: /bin/bash
      loop: "{{ dc_ctids }}"
      register: apt_run
      retries: 3
      delay: 30
      until: apt_run is succeeded


    # --- resolved sauber aktivieren (wird später von Playbook 05 überschrieben) ---
    - name: resolved aktivieren & /etc/resolv.conf symlink setzen
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc "
          systemctl enable --now systemd-resolved || true
          ln -snf /run/systemd/resolve/resolv.conf /etc/resolv.conf || true
        "
      loop: "{{ dc_ctids }}"

    # --- Health Checks grundlegend ---
    - name: DRS Replikation prüfen (best effort)
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc 'samba-tool drs showrepl'
      register: drs_res
      failed_when: false
      loop: "{{ dc_ctids }}"

    - name: wbinfo trust check
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc 'wbinfo -t'
      register: wbinfo_res
      failed_when: false
      loop: "{{ dc_ctids }}"

    - name: SYSVOL vorhanden?
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc 'test -d /var/lib/samba/sysvol && echo OK || (echo FAIL; exit 1)'
      loop: "{{ dc_ctids }}"

