# Playbook 04: Debian-13-Upgrade & Samba/DC Health-Checks (robust)
---
- name: Upgrade & Health-Checks für Zamba-DCs (Debian 13 "Trixie")
  hosts: pve3
  gather_facts: false
  vars:
    dc_ctids: [100, 101]
    # während des Bootstraps (erstes apt update) nutzen wir einen externen Resolver
    bootstrap_resolver: "1.1.1.1"
    ad_domain: "amazonistan.intranet"

  tasks:
    - name: Erzeuge Log-Verzeichnis in jedem CT
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc 'mkdir -p /root/ad-upgrade-logs'
      loop: "{{ dc_ctids }}"

    - name: Stelle sicher, dass die Container laufen
      ansible.builtin.shell: |
        pct start {{ item }} || true
      loop: "{{ dc_ctids }}"

    # --- Bootstrap-DNS: temporär /etc/resolv.conf setzen (korrekt gequotet) ---
    - name: Setze temporäre /etc/resolv.conf (Bootstrap) in jedem CT
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc "cat > /etc/resolv.conf <<'EOF'
        search {{ ad_domain }}
        nameserver {{ bootstrap_resolver }}
        EOF
        "
      loop: "{{ dc_ctids }}"

    - name: Warte auf Netzwerk im CT (DNS-Auflösung extern)
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc 'getent hosts deb.debian.org'
      register: netcheck
      retries: 20
      delay: 3
      until: netcheck.rc == 0
      loop: "{{ dc_ctids }}"

    # --- Upgrade auf Debian 13 (falls noch nicht) ---
    - name: Setze trixie-Sources (falls nötig)
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc "release=$(cut -d. -f1 /etc/debian_version); \
        if [ \"$release\" != \"13\" ]; then \
          sed -i 's/bookworm/trixie/g' /etc/apt/sources.list /etc/apt/sources.list.d/*.list 2>/dev/null || true; \
        fi"
      loop: "{{ dc_ctids }}"

    - name: apt update & full-upgrade
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc 'apt update && apt -y full-upgrade'
      loop: "{{ dc_ctids }}"

    # --- resolved sauber aktivieren (wird später von Playbook 05 überschrieben) ---
    - name: resolved aktivieren & /etc/resolv.conf symlink setzen
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc "
          systemctl enable --now systemd-resolved || true
          ln -snf /run/systemd/resolve/resolv.conf /etc/resolv.conf || true
        "
      loop: "{{ dc_ctids }}"

    # --- Health Checks grundlegend ---
    - name: DRS Replikation prüfen (best effort)
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc 'samba-tool drs showrepl'
      register: drs_res
      failed_when: false
      loop: "{{ dc_ctids }}"

    - name: wbinfo trust check
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc 'wbinfo -t'
      register: wbinfo_res
      failed_when: false
      loop: "{{ dc_ctids }}"

    - name: SYSVOL vorhanden?
      ansible.builtin.shell: |
        pct exec {{ item }} -- bash -lc 'test -d /var/lib/samba/sysvol && echo OK || (echo FAIL; exit 1)'
      loop: "{{ dc_ctids }}"

