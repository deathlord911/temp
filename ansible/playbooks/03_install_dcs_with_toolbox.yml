---
- name: Installiere Zamba DCs mit der lxc-toolbox (auto-confirm)
  hosts: pve3
  gather_facts: false

  vars:
    toolbox_dir: /root/zamba-lxc-toolbox

  pre_tasks:
    - name: Prüfe, ob install.sh existiert und ausführbar ist
      stat:
        path: "{{ toolbox_dir }}/install.sh"
      register: inst
      changed_when: false

    - name: Abbrechen, falls install.sh fehlt/unerlaubt
      fail:
        msg: "install.sh fehlt oder ist nicht ausführbar unter {{ toolbox_dir }}/install.sh"
      when: not inst.stat.exists or not inst.stat.mode | int(base=8) is search("..1")

  tasks:
    - name: Installiere {{ dc_a.hn }} (CT {{ dc_a.ctid }}) auf {{ dc_a.storage }} via install.sh
      shell: >
        "{{ toolbox_dir }}/install.sh" -i {{ dc_a.ctid }} -s zmb-ad
      args:
        executable: /bin/bash

    - name: Installiere {{ dc_b.hn }} (CT {{ dc_b.ctid }}) auf {{ dc_b.storage }} via install.sh
      shell: >
        "{{ toolbox_dir }}/install.sh" -i {{ dc_b.ctid }} -s zmb-ad-join
      args:
        executable: /bin/bash

    # --- Minimales Nachziehen: Storage/Netz nur dann anpassen, wenn wirklich abweichend ---

    - name: DC A anhalten (best effort)
      shell: pct shutdown {{ dc_a.ctid }} --force-stop 1 || true
      args: { executable: /bin/bash }

    - name: DC A: Rootfs-Storage prüfen/angleichen
      shell: |
        cur=$(pct config {{ dc_a.ctid }} | sed -n 's/^rootfs: \([^:]*\):.*/\1/p')
        if [ "$cur" != "{{ dc_a.storage }}" ]; then
          pct move-volume {{ dc_a.ctid }} rootfs {{ dc_a.storage }} --delete 1
        fi
      args: { executable: /bin/bash }

    - name: DC A: Netz und Resolver setzen (vmbr3/VLAN100/IP/GW)
      shell: |
        MAC=$(pct config {{ dc_a.ctid }} | sed -n 's/^net0: .*hwaddr=\([^,]*\).*/\1/p')
        pct set {{ dc_a.ctid }} -net0 "name=eth0,bridge={{ net_bridge }},ip={{ dc_a.ip }}/{{ net_masklen }},gw={{ net_gw }},tag={{ net_vlan }},type=veth,firewall=1,hwaddr=$MAC"
        pct set {{ dc_a.ctid }} -nameserver "{{ dns_fallback | join(" ") }}" -searchdomain {{ domain }}
      args: { executable: /bin/bash }

    - name: DC A starten
      shell: pct start {{ dc_a.ctid }}
      args: { executable: /bin/bash }

    - name: DC B anhalten (best effort)
      shell: pct shutdown {{ dc_b.ctid }} --force-stop 1 || true
      args: { executable: /bin/bash }

    - name: DC B: Rootfs-Storage prüfen/angleichen
      shell: |
        cur=$(pct config {{ dc_b.ctid }} | sed -n 's/^rootfs: \([^:]*\):.*/\1/p')
        if [ "$cur" != "{{ dc_b.storage }}" ]; then
          pct move-volume {{ dc_b.ctid }} rootfs {{ dc_b.storage }} --delete 1
        fi
      args: { executable: /bin/bash }

    - name: DC B: Netz und Resolver setzen (vmbr3/VLAN100/IP/GW)
      shell: |
        MAC=$(pct config {{ dc_b.ctid }} | sed -n 's/^net0: .*hwaddr=\([^,]*\).*/\1/p')
        pct set {{ dc_b.ctid }} -net0 "name=eth0,bridge={{ net_bridge }},ip={{ dc_b.ip }}/{{ net_masklen }},gw={{ net_gw }},tag={{ net_vlan }},type=veth,firewall=1,hwaddr=$MAC"
        pct set {{ dc_b.ctid }} -nameserver "{{ dns_fallback | join(" ") }}" -searchdomain {{ domain }}
      args: { executable: /bin/bash }

    - name: DC B starten
      shell: pct start {{ dc_b.ctid }}
      args: { executable: /bin/bash }
