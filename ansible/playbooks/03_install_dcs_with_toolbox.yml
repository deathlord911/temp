---
# 03_install_dcs_with_toolbox.yml
# Installiert beide Zamba-DCs via Toolbox, ohne die Toolbox-Configs zu verändern.
# Ziel-Storage:
#   CT100 -> raidpool
#   CT101 -> ceph-rbd
# Nach der Installation wird – falls abweichend – per pct move-volume umgezogen.

- name: Installiere Zamba DCs mit der zamba-lxc-toolbox (mit Live-Output + Storage-Move)
  hosts: pve3
  gather_facts: false
  vars:
    toolbox_dir: "/root/zamba-lxc-toolbox"
    conf_ad: "/root/zamba-conf/zmb-ad.new.conf"
    conf_join: "/root/zamba-conf/zmb-ad-join.new.conf"

    ct100_id: 100
    ct101_id: 101

    # SOLL-Storage je CT
    ct100_storage: "raidpool"
    ct101_storage: "ceph-rbd"

    reports_dir: "/root/temp/ansible/playbooks/reports"

  tasks:
    #################################################################
    # Vorbedingungen
    #################################################################
    - name: Reports-Verzeichnis anlegen
      ansible.builtin.file:
        path: "{{ reports_dir }}"
        state: directory
        mode: "0755"

    - name: Toolbox prüfen
      ansible.builtin.stat:
        path: "{{ toolbox_dir }}/install.sh"
      register: _toolbox

    - name: Abbruch wenn install.sh fehlt
      ansible.builtin.fail:
        msg: "Toolbox fehlt: {{ toolbox_dir }}/install.sh"
      when: not _toolbox.stat.exists

    - name: install.sh ausführbar machen
      ansible.builtin.file:
        path: "{{ toolbox_dir }}/install.sh"
        mode: "0755"

    - name: Konfigdateien vorhanden?
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - "{{ conf_ad }}"
        - "{{ conf_join }}"
      register: _conf_stats

    - name: Abbruch wenn Konfigdateien fehlen
      ansible.builtin.fail:
        msg: "Konfigdateien fehlen: {{ (_conf_stats.results | rejectattr('stat.exists') | map(attribute='item') | list) }}"
      when: (_conf_stats.results | selectattr('stat.exists','equalto',false) | list | length) > 0

    - name: "Check: Storage {{ ct100_storage }} vorhanden?"
      ansible.builtin.shell: |
        pvesm status | awk 'NR>1{print $1}' | grep -Fx "{{ ct100_storage }}"
      register: _has_ct100_storage
      changed_when: false
      failed_when: false

    - name: "Check: Storage {{ ct101_storage }} vorhanden?"
      ansible.builtin.shell: |
        pvesm status | awk 'NR>1{print $1}' | grep -Fx "{{ ct101_storage }}"
      register: _has_ct101_storage
      changed_when: false
      failed_when: false

    - name: Abbruch wenn gewünschte Storages fehlen
      ansible.builtin.fail:
        msg: "Fehlende Storages: {{ missing }}"
      vars:
        missing: >-
          {{
            ([ct100_storage] if (_has_ct100_storage.rc|default(1)) != 0 else []) +
            ([ct101_storage] if (_has_ct101_storage.rc|default(1)) != 0 else [])
          }}
      when: (_has_ct100_storage.rc|default(1)) != 0 or (_has_ct101_storage.rc|default(1)) != 0

    #################################################################
    # Optionaler Vor-Scan (kann leer sein)
    #################################################################
    - name: Finde CT100 Configpfad clusterweit
      ansible.builtin.shell: |
        for n in /etc/pve/nodes/*; do
          test -e "$n/lxc/{{ ct100_id }}.conf" && echo "$n/lxc/{{ ct100_id }}.conf"
        done
        exit 0
      register: _conf100_before
      changed_when: false
      failed_when: false

    - name: Finde CT101 Configpfad clusterweit
      ansible.builtin.shell: |
        for n in /etc/pve/nodes/*; do
          test -e "$n/lxc/{{ ct101_id }}.conf" && echo "$n/lxc/{{ ct101_id }}.conf"
        done
        exit 0
      register: _conf101_before
      changed_when: false
      failed_when: false

    #################################################################
    # Installation via Toolbox (non-interaktiv mit -s/-i/-c)
    #################################################################
    - name: "Toolbox-Install CT{{ ct100_id }} (zmb-ad) – Live-Output"
      ansible.builtin.shell: |
        set -e
        cd "{{ toolbox_dir }}"
        ./install.sh -s zmb-ad -i {{ ct100_id }} -c "{{ conf_ad }}"
      args:
        chdir: "{{ toolbox_dir }}"
      register: _inst100
      changed_when: true
      failed_when: false

    - name: "Toolbox-Install CT{{ ct101_id }} (zmb-ad-join) – Live-Output"
      ansible.builtin.shell: |
        set -e
        cd "{{ toolbox_dir }}"
        ./install.sh -s zmb-ad-join -i {{ ct101_id }} -c "{{ conf_join }}"
      args:
        chdir: "{{ toolbox_dir }}"
      register: _inst101
      changed_when: true
      failed_when: false

    #################################################################
    # Validierung: existieren die CTs jetzt wirklich?
    #################################################################
    - name: Re-scan CT100 Configpfad clusterweit
      ansible.builtin.shell: |
        for n in /etc/pve/nodes/*; do
          test -e "$n/lxc/{{ ct100_id }}.conf" && echo "$n/lxc/{{ ct100_id }}.conf"
        done
        exit 0
      register: _conf100_after
      changed_when: false
      failed_when: false

    - name: Re-scan CT101 Configpfad clusterweit
      ansible.builtin.shell: |
        for n in /etc/pve/nodes/*; do
          test -e "$n/lxc/{{ ct101_id }}.conf" && echo "$n/lxc/{{ ct101_id }}.conf"
        done
        exit 0
      register: _conf101_after
      changed_when: false
      failed_when: false

    - name: Fail wenn CT100 nicht erzeugt wurde
      ansible.builtin.fail:
        msg: |
          CT {{ ct100_id }} wurde nach Toolbox-Install nicht gefunden.
          Bitte Toolbox-Logs prüfen.
          ---- stdout (tail) ----
          {{ (_inst100.stdout | default(''))[-2000:] }}
          ---- stderr (tail) ----
          {{ (_inst100.stderr | default(''))[-2000:] }}
      when: (_conf100_after.stdout | trim | length) == 0

    - name: Fail wenn CT101 nicht erzeugt wurde
      ansible.builtin.fail:
        msg: |
          CT {{ ct101_id }} wurde nach Toolbox-Install nicht gefunden.
          Bitte Toolbox-Logs prüfen.
          ---- stdout (tail) ----
          {{ (_inst101.stdout | default(''))[-2000:] }}
          ---- stderr (tail) ----
          {{ (_inst101.stderr | default(''))[-2000:] }}
      when: (_conf101_after.stdout | trim | length) == 0

    - name: Node-Facts nach Installation
      ansible.builtin.set_fact:
        ct100_conf: "{{ _conf100_after.stdout | trim }}"
        ct101_conf: "{{ _conf101_after.stdout | trim }}"
        ct100_node: "{{ (ct100_conf | regex_search('/etc/pve/nodes/([^/]+)/', '\\1')) | default('pve3', true) }}"
        ct101_node: "{{ (ct101_conf | regex_search('/etc/pve/nodes/([^/]+)/', '\\1')) | default('pve3', true) }}"

    #################################################################
    # Ist-Storage je CT aus der .conf lesen
    #################################################################
    - name: "CT100: aktuellen rootfs-Storage ermitteln"
      ansible.builtin.shell: |
        awk -F': ' '/^rootfs: /{print $2}' "{{ ct100_conf }}" | awk -F':' '{print $1}'
      register: _ct100_storage_now
      changed_when: false

    - name: "CT101: aktuellen rootfs-Storage ermitteln"
      ansible.builtin.shell: |
        awk -F': ' '/^rootfs: /{print $2}' "{{ ct101_conf }}" | awk -F':' '{print $1}'
      register: _ct101_storage_now
      changed_when: false

    - name: Debug Ist/Soll Storage
      ansible.builtin.debug:
        msg:
          - "CT100: IST='{{ _ct100_storage_now.stdout | trim }}'  SOLL='{{ ct100_storage }}'"
          - "CT101: IST='{{ _ct101_storage_now.stdout | trim }}'  SOLL='{{ ct101_storage }}'"

    #################################################################
    # Falls nötig: rootfs auf Ziel-Storage verschieben
    #################################################################
    - name: "CT100: rootfs nach {{ ct100_storage }} verschieben (falls abweichend)"
      when: (_ct100_storage_now.stdout | trim) != ct100_storage
      delegate_to: "{{ ct100_node | default('pve3') }}"
      ansible.builtin.shell: |
        pct stop {{ ct100_id }} || true
        pct move-volume {{ ct100_id }} rootfs {{ ct100_storage }}
        pct start {{ ct100_id }}
      register: _move100
      changed_when: true

    - name: "CT101: rootfs nach {{ ct101_storage }} verschieben (falls abweichend)"
      when: (_ct101_storage_now.stdout | trim) != ct101_storage
      delegate_to: "{{ ct101_node | default('pve3') }}"
      ansible.builtin.shell: |
        pct stop {{ ct101_id }} || true
        pct move-volume {{ ct101_id }} rootfs {{ ct101_storage }}
        pct start {{ ct101_id }}
      register: _move101
      changed_when: true

    #################################################################
    # Abschluss-Check
    #################################################################
    - name: "CT100: Storage-Check nach Move"
      ansible.builtin.shell: |
        awk -F': ' '/^rootfs: /{print $2}' "{{ ct100_conf }}" | awk -F':' '{print $1}'
      register: _ct100_storage_final
      changed_when: false

    - name: "CT101: Storage-Check nach Move"
      ansible.builtin.shell: |
        awk -F': ' '/^rootfs: /{print $2}' "{{ ct101_conf }}" | awk -F':' '{print $1}'
      register: _ct101_storage_final
      changed_when: false

    - name: Zusammenfassung
      ansible.builtin.debug:
        msg:
          - "CT100 final: {{ _ct100_storage_final.stdout | trim }}"
          - "CT101 final: {{ _ct101_storage_final.stdout | trim }}"
