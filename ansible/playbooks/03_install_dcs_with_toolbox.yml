---
- name: Installiere Zamba DCs mit der lxc-toolbox (auto-confirm, storage-enforced)
  hosts: pve3
  gather_facts: false

  vars:
    toolbox_dir: /root/zamba-lxc-toolbox
    outdir: /root/zamba-conf

  pre_tasks:
    - name: Prüfe install.sh vorhanden
      stat:
        path: "{{ toolbox_dir }}/install.sh"
      register: inst
      changed_when: false

    - name: Abbrechen, falls install.sh fehlt
      fail:
        msg: "install.sh fehlt unter {{ toolbox_dir }} – bitte Repo der zamba-lxc-toolbox bereitstellen."
      when: not inst.stat.exists

    - name: Prüfe Konfigdateien aus 02 (zmb-ad.new.conf / zmb-ad-join.new.conf)
      stat:
        path: "{{ item }}"
      loop:
        - "{{ outdir }}/zmb-ad.new.conf"
        - "{{ outdir }}/zmb-ad-join.new.conf"
      register: cfgs
      changed_when: false

    - name: Abbrechen, falls Konfigs fehlen
      fail:
        msg: "Konfigdateien fehlen unter {{ outdir }} – bitte Playbook 02 ausführen."
      when: >
        (cfgs.results | selectattr('stat.exists', 'equalto', false) | list | length) > 0

  tasks:
    ###########################################################################
    # 1) Installation per install.sh (nicht interaktiv; -i/-s/-c genutzt)
    ###########################################################################
    - name: "Installiere {{ dc_a.hn }} (CT {{ dc_a.ctid }}) via install.sh (SERVICE=zmb-ad)"
      shell: >
        "{{ toolbox_dir }}/install.sh"
        -i {{ dc_a.ctid }} -s zmb-ad -c "{{ outdir }}/zmb-ad.new.conf"
      args:
        chdir: "{{ toolbox_dir }}"
        executable: /bin/bash

    - name: "Installiere {{ dc_b.hn }} (CT {{ dc_b.ctid }}) via install.sh (SERVICE=zmb-ad-join)"
      shell: >
        "{{ toolbox_dir }}/install.sh"
        -i {{ dc_b.ctid }} -s zmb-ad-join -c "{{ outdir }}/zmb-ad-join.new.conf"
      args:
        chdir: "{{ toolbox_dir }}"
        executable: /bin/bash

    ###########################################################################
    # 2) Storage-Layout ENFORCEN
    #    - DC A (zmb-ad): rootfs == raidpool, mp0 == raidpool
    #    - DC B (zmb-ad-join): rootfs == ceph-rbd, KEIN mp0
    ###########################################################################
    - name: "DC A ({{ dc_a.ctid }}): Container stoppen (best effort)"
      shell: "pct stop {{ dc_a.ctid }}"
      register: stop_a
      failed_when: false
      changed_when: "'stopped' in (stop_a.stderr | default('')) or (stop_a.rc == 0)"

    - name: "DC A ({{ dc_a.ctid }}): Snapshots löschen (falls vorhanden)"
      shell: |
        set -e
        snaps=$(pct listsnapshot {{ dc_a.ctid }} 2>/dev/null | awk 'NR>1{print $1}')
        if [ -n "$snaps" ]; then
          echo "$snaps" | xargs -r -I{} pct delsnapshot {{ dc_a.ctid }} {}
        fi
      args:
        executable: /bin/bash
      changed_when: false

    - name: "DC A ({{ dc_a.ctid }}): Rootfs-Storage prüfen/angleichen (soll: {{ dc_a.storage }})"
      shell: |
        cur=$(pct config {{ dc_a.ctid }} | sed -n 's/^rootfs: \([^:]*\):.*/\1/p')
        if [ "$cur" != "{{ dc_a.storage }}" ]; then
          pct move-volume {{ dc_a.ctid }} rootfs {{ dc_a.storage }} --delete 1
        fi
      args: { executable: /bin/bash }

    - name: "DC A ({{ dc_a.ctid }}): mp0-Storage prüfen/angleichen (soll: {{ dc_a.storage }})"
      shell: |
        set -e
        line=$(pct config {{ dc_a.ctid }} | sed -n 's/^mp0: \(.*\)$/\1/p')
        if [ -n "$line" ]; then
          cur=$(echo "$line" | awk -F: '{print $1}')
          if [ "$cur" != "{{ dc_a.storage }}" ]; then
            pct move-volume {{ dc_a.ctid }} mp0 {{ dc_a.storage }} --delete 1
          fi
        fi
      args: { executable: /bin/bash }

    - name: "DC A ({{ dc_a.ctid }}): Container starten"
      shell: "pct start {{ dc_a.ctid }}"
      changed_when: true

    - name: "DC B ({{ dc_b.ctid }}): Container stoppen (best effort)"
      shell: "pct stop {{ dc_b.ctid }}"
      register: stop_b
      failed_when: false
      changed_when: "'stopped' in (stop_b.stderr | default('')) or (stop_b.rc == 0)"

    - name: "DC B ({{ dc_b.ctid }}): Snapshots löschen (falls vorhanden)"
      shell: |
        set -e
        snaps=$(pct listsnapshot {{ dc_b.ctid }} 2>/dev/null | awk 'NR>1{print $1}')
        if [ -n "$snaps" ]; then
          echo "$snaps" | xargs -r -I{} pct delsnapshot {{ dc_b.ctid }} {}
        fi
      args:
        executable: /bin/bash
      changed_when: false

    - name: "DC B ({{ dc_b.ctid }}): Rootfs-Storage prüfen/angleichen (soll: {{ dc_b.storage }})"
      shell: |
        cur=$(pct config {{ dc_b.ctid }} | sed -n 's/^rootfs: \([^:]*\):.*/\1/p')
        if [ "$cur" != "{{ dc_b.storage }}" ]; then
          pct move-volume {{ dc_b.ctid }} rootfs {{ dc_b.storage }} --delete 1
        fi
      args: { executable: /bin/bash }

    - name: "DC B ({{ dc_b.ctid }}): sicherstellen, dass KEIN mp0 existiert (falls doch, löschen)"
      shell: |
        set -e
        if pct config {{ dc_b.ctid }} | grep -q '^mp0:'; then
          pct set {{ dc_b.ctid }} -delete mp0
        fi
      args: { executable: /bin/bash }

    - name: "DC B ({{ dc_b.ctid }}): Container starten"
      shell: "pct start {{ dc_b.ctid }}"
      changed_when: true

    ###########################################################################
    # 3) Verifikation
    ###########################################################################
    - name: "Verifiziere Storage-Zuordnung CT100/101"
      shell: |
        echo "CT{{ dc_a.ctid }} config:"
        pct config {{ dc_a.ctid }} | egrep '^rootfs:|^mp0:|^net0:'
        echo
        echo "CT{{ dc_b.ctid }} config:"
        pct config {{ dc_b.ctid }} | egrep '^rootfs:|^mp0:|^net0:'
      register: verify
      changed_when: false

    - name: Ausgabe Verifikation
      debug:
        msg: "{{ verify.stdout.split('\n') }}"
