---
- name: Installiere Zamba DCs mit der lxc-toolbox (auto-confirm)
  hosts: pve3
  gather_facts: false

  vars:
    toolbox_dir: /root/zamba-lxc-toolbox

  pre_tasks:
    - name: Prüfe, ob die Toolbox vorhanden ist
      stat:
        path: "{{ toolbox_dir }}/install.sh"
      register: toolbox

    - name: Abbrechen, falls Toolbox fehlt
      fail:
        msg: "lxc-toolbox fehlt unter {{ toolbox_dir }} – bitte vorher bereitstellen."
      when: not toolbox.stat.exists

    - name: Ceph-Storage vorhanden? (nur prüfen, wenn dc_a auf ceph-rbd soll)
      shell: "pvesm status | awk '{print $1}' | grep -x ceph-rbd"
      register: ceph_check
      changed_when: false
      failed_when: dc_a.storage == 'ceph-rbd' and ceph_check.rc != 0

  tasks:
    - name: Installiere {{ dc_a.hn }} (CT {{ dc_a.ctid }}) auf {{ dc_a.storage }}
      shell: >
        {{ toolbox_dir }}/install.sh install
        --ctid {{ dc_a.ctid }}
        --hostname {{ dc_a.hn }}
        --ip {{ dc_a.ip }}
        --domain {{ domain }}
        --storage {{ dc_a.storage }}
        --start
      args:
        chdir: "{{ toolbox_dir }}"
        executable: /bin/bash

    - name: Installiere {{ dc_b.hn }} (CT {{ dc_b.ctid }}) auf {{ dc_b.storage }}
      shell: >
        {{ toolbox_dir }}/install.sh install
        --ctid {{ dc_b.ctid }}
        --hostname {{ dc_b.hn }}
        --ip {{ dc_b.ip }}
        --domain {{ domain }}
        --storage {{ dc_b.storage }}
        --start
      args:
        chdir: "{{ toolbox_dir }}"
        executable: /bin/bash
