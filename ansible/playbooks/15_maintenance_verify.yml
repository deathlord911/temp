---
- name: Maintenance / Verification (Ceph, APT, Timers, AD, Backups)
  hosts: localhost
  gather_facts: false

  vars:
    report_dir: "{{ playbook_dir }}/reports"
    drs_cts: [100, 101]            # unsere beiden DC-Container
    ad_backup_ct: 100              # CT fÃ¼r AD-Backups
    ad_backup_dir_ct: "/backup/samba-ad"
    ad_backup_max_age_days: 7
    apt_lock_files:
      - /var/lib/dpkg/lock
      - /var/lib/dpkg/lock-frontend
      - /var/cache/apt/archives/lock
      - /var/lib/apt/lists/lock

  tasks:
    #####################################################################
    # Report-Verzeichnis + Timestamp
    #####################################################################
    - name: Ensure reports directory exists
      ansible.builtin.file:
        path: "{{ report_dir }}"
        state: directory
        mode: "0755"

    - name: Timestamp for report
      ansible.builtin.set_fact:
        _ts: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"
        report_path: "{{ report_dir }}/maintenance-{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}.md"

    - name: Init maintenance counters and notes
      ansible.builtin.set_fact:
        maintenance_issues: 0
        maintenance_notes: []

    #####################################################################
    # Ceph Health (optional, wenn ceph vorhanden)
    #####################################################################
    - name: Get Ceph health (JSON) if ceph is present
      ansible.builtin.shell: |
        set -euo pipefail
        if command -v ceph >/dev/null 2>&1; then
          ceph status --format json || true
        else
          echo ''
        fi
      args:
        executable: /bin/bash
      register: _ceph_health_raw
      changed_when: false
      failed_when: false

    - name: Normalize ceph stdout to string
      ansible.builtin.set_fact:
        _ceph_stdout: "{{ (_ceph_health_raw.stdout | default('')) | string }}"

    - name: Parse Ceph health JSON
      ansible.builtin.set_fact:
        _ceph_health: "{{ (_ceph_stdout | length > 2) | ternary((_ceph_stdout | from_json), {}) }}"
        _ceph_status: "{{ (_ceph_stdout | length > 2) | ternary(((_ceph_stdout | from_json).health.status | default('N/A')), 'N/A') }}"

    - name: Record Ceph health finding (if not HEALTH_OK)
      ansible.builtin.set_fact:
        maintenance_issues: "{{ (maintenance_issues | int) + (( _ceph_status != 'HEALTH_OK') | int) }}"
        maintenance_notes: >-
          {{ maintenance_notes
             + ( [ 'Ceph not HEALTH_OK: ' ~ _ceph_status ] if (_ceph_status != 'HEALTH_OK') else [] ) }}

    #####################################################################
    # Systemd Timer/Services Guards
    #####################################################################
    - name: Check ceph-safe-update.timer enabled
      ansible.builtin.shell: "systemctl is-enabled ceph-safe-update.timer || true"
      register: _ceph_timer_enabled
      changed_when: false
      failed_when: false

    - name: Flag if ceph-safe-update.timer not enabled
      ansible.builtin.set_fact:
        maintenance_issues: "{{ (maintenance_issues | int) + ((_ceph_timer_enabled.stdout | trim != 'enabled') | int) }}"
        maintenance_notes: >-
          {{ maintenance_notes
             + ( [ 'ceph-safe-update.timer is not enabled (' ~ (_ceph_timer_enabled.stdout | trim) ~ ')' ]
                 if (_ceph_timer_enabled.stdout | trim != 'enabled') else [] ) }}

    - name: Check pve-auto-upgrades.timer enabled
      ansible.builtin.shell: "systemctl is-enabled pve-auto-upgrades.timer || true"
      register: _pve_timer_enabled
      changed_when: false
      failed_when: false

    - name: Check pve-auto-upgrades.timer active
      ansible.builtin.shell: "systemctl is-active pve-auto-upgrades.timer || true"
      register: _pve_timer_active
      changed_when: false
      failed_when: false

    - name: Flag if pve-auto-upgrades.timer enabled or active
      ansible.builtin.set_fact:
        maintenance_issues: "{{ (maintenance_issues | int)
                                + ((_pve_timer_enabled.stdout | trim == 'enabled') | int)
                                + ((_pve_timer_active.stdout | trim == 'active') | int) }}"
        maintenance_notes: >-
          {{ maintenance_notes
             + ( [ 'pve-auto-upgrades.timer should be disabled (is ' ~ (_pve_timer_enabled.stdout | trim) ~ ')' ]
                 if (_pve_timer_enabled.stdout | trim == 'enabled') else [] )
             + ( [ 'pve-auto-upgrades.timer should be inactive (is ' ~ (_pve_timer_active.stdout | trim) ~ ')' ]
                 if (_pve_timer_active.stdout | trim == 'active') else [] ) }}

    - name: Check unattended-upgrades.service masked
      ansible.builtin.shell: "systemctl is-enabled unattended-upgrades.service || true"
      register: _uunatt_enabled
      changed_when: false
      failed_when: false

    - name: Flag if unattended-upgrades not masked
      ansible.builtin.set_fact:
        maintenance_issues: "{{ (maintenance_issues | int) + ((_uunatt_enabled.stdout | trim != 'masked') | int) }}"
        maintenance_notes: >-
          {{ maintenance_notes
             + ( [ 'unattended-upgrades.service should be masked (is ' ~ (_uunatt_enabled.stdout | trim) ~ ')' ]
                 if (_uunatt_enabled.stdout | trim != 'masked') else [] ) }}

    #####################################################################
    # APT Busy / Locks
    #####################################################################
    - name: Detect APT/DPKG busy processes
      ansible.builtin.shell: |
        set -euo pipefail
        ps -eo comm= | egrep -E '^(apt|apt-get|aptitude|dpkg|unattended-upgrade|aptd)$' | wc -l
      args:
        executable: /bin/bash
      register: _apt_busy_count
      changed_when: false
      failed_when: false

    - name: Compute APT busy bool
      ansible.builtin.set_fact:
        _apt_busy: "{{ (_apt_busy_count.stdout | default('0') | int) > 0 }}"

    - name: Flag if APT/DPKG busy
      ansible.builtin.set_fact:
        maintenance_issues: "{{ (maintenance_issues | int) + (_apt_busy | int) }}"
        maintenance_notes: >-
          {{ maintenance_notes + ( ['APT/DPKG still busy'] if _apt_busy else [] ) }}

    - name: Detect common APT lock files
      ansible.builtin.stat:
        path: "{{ item }}"
      loop: "{{ apt_lock_files }}"
      register: _apt_locks

    - name: Build list of present APT lock files
      ansible.builtin.set_fact:
        _apt_locks_present: >-
          {{ _apt_locks.results
             | selectattr('stat.exists','defined')
             | selectattr('stat.exists')
             | map(attribute='stat.path', default='{{ item }}')
             | list }}

    - name: Flag if APT locks present
      ansible.builtin.set_fact:
        maintenance_issues: "{{ (maintenance_issues | int) + (( _apt_locks_present | length > 0 ) | int) }}"
        maintenance_notes: >-
          {{ maintenance_notes
             + ( [ 'APT locks present: ' ~ (_apt_locks_present | join(', ')) ]
                 if (_apt_locks_present | length > 0) else [] ) }}

    #####################################################################
    # DRS showrepl (Fehlerindikatoren)
    #####################################################################
    - name: DRS showrepl on each DC
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ item }} -- bash -lc 'samba-tool drs showrepl 2>&1 || true'
      args:
        executable: /bin/bash
      loop: "{{ drs_cts }}"
      register: _drs_out
      changed_when: false
      failed_when: false

    - name: Flag if DRS output indicates errors
      ansible.builtin.set_fact:
        maintenance_issues: >-
          {{ (maintenance_issues | int)
             + ( (_drs_out.results | selectattr('stdout','search','ERROR') | list | length) | int ) }}
        maintenance_notes: >-
          {{ maintenance_notes
             + ( _drs_out.results
                 | selectattr('stdout','search','ERROR')
                 | map(attribute='item')
                 | map('regex_replace','^(.*)$','DRS showrepl has ERROR in CT \\1')
                 | list ) }}

    #####################################################################
    # NETLOGON / SYSVOL Check (ohne Anonymous-Listing)
    #####################################################################
    - name: Check NETLOGON/SYSVOL presence via testparm in each DC
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ item }} -- bash -lc '
          testparm -s 2>/dev/null | awk "
            BEGIN{net=0;sys=0}
            /^\[netlogon\]/{net=1}
            /^\[sysvol\]/{sys=1}
            END{
              printf(\"netlogon=%s sysvol=%s\n\", net?\"present\":\"missing\", sys?\"present\":\"missing\")
            }"
        '
      args:
        executable: /bin/bash
      register: _netlogon_sysvol
      loop: "{{ drs_cts }}"
      changed_when: false
      failed_when: false

    - name: Flag if NETLOGON/SYSVOL missing
      ansible.builtin.set_fact:
        maintenance_issues: >-
          {{ (maintenance_issues | int)
             + ( (_netlogon_sysvol.results
                  | selectattr('stdout','search','netlogon=missing')
                  | list | length) | int )
             + ( (_netlogon_sysvol.results
                  | selectattr('stdout','search','sysvol=missing')
                  | list | length) | int ) }}
        maintenance_notes: >-
          {{ maintenance_notes
             + (_netlogon_sysvol.results
                | selectattr('stdout','search','netlogon=missing')
                | map(attribute='item')
                | map('regex_replace','^(.*)$','NETLOGON missing in CT \\1')
                | list)
             + (_netlogon_sysvol.results
                | selectattr('stdout','search','sysvol=missing')
                | map(attribute='item')
                | map('regex_replace','^(.*)$','SYSVOL missing in CT \\1')
                | list)
          }}

    #####################################################################
    # AD Backup (im CT100 suchen)
    #####################################################################
    - name: Find latest AD backup file inside CT100
      ansible.builtin.shell: |
        set -euo pipefail
        pct exec {{ ad_backup_ct }} -- bash -lc '
          shopt -s nullglob
          latest=$(ls -1t {{ ad_backup_dir_ct }}/*.{tar.bz2,tar.gz} 2>/dev/null | head -n1 || true)
          echo "$latest"
        '
      args:
        executable: /bin/bash
      register: _ad_backup_latest
      changed_when: false
      failed_when: false

    - name: Compute backup age in days (inside CT100)
      ansible.builtin.shell: |
        set -euo pipefail
        f="{{ _ad_backup_latest.stdout | trim }}"
        if [ -z "$f" ]; then
          echo 99999
          exit 0
        fi
        pct exec {{ ad_backup_ct }} -- bash -lc "test -e \"$f\" && echo \$(( ( \$(date +%s) - \$(stat -c %Y \"$f\") ) / 86400 )) || echo 99999"
      args:
        executable: /bin/bash
      register: _ad_backup_age_days
      changed_when: false
      failed_when: false

    - name: Flag if no fresh AD backup found (<= 7d)
      ansible.builtin.set_fact:
        maintenance_issues: "{{ (maintenance_issues | int) + (((_ad_backup_age_days.stdout | trim | int) > ad_backup_max_age_days) | int) }}"
        maintenance_notes: >-
          {{ maintenance_notes
             + ( [ 'No fresh AD backup (<= ' ~ ad_backup_max_age_days ~ 'd) in CT ' ~ ad_backup_ct
                   ~ '; latest: ' ~ (_ad_backup_latest.stdout | trim) ]
                 if ( (_ad_backup_age_days.stdout | trim | int) > ad_backup_max_age_days ) else [] ) }}

    #####################################################################
    # Report schreiben
    #####################################################################
    - name: Build report content
      ansible.builtin.set_fact:
        _report_md: |-
          # Maintenance Report ({{ _ts }})

          **Issues found:** {{ maintenance_issues }}
          - ceph-safe-update.timer enabled: {{ _ceph_timer_enabled.stdout | default('') | trim }}
          - pve-auto-upgrades.timer enabled: {{ _pve_timer_enabled.stdout | default('') | trim }}
          - pve-auto-upgrades.timer active:  {{ _pve_timer_active.stdout | default('') | trim }}
          - unattended-upgrades.service is-enabled: {{ _uunatt_enabled.stdout | default('') | trim }}
          - APT busy: {{ _apt_busy | default(false) }}
          - APT locks: {{ (_apt_locks_present | length > 0) | ternary((_apt_locks_present | join(', ')),'none') }}
          - Ceph status: {{ _ceph_status }}

          ## Notes
          {% if maintenance_notes | length == 0 -%}
          (none)
          {%- else -%}
          {% for n in maintenance_notes -%}
          - {{ n }}
          {% endfor -%}
          {%- endif %}

    - name: Write report file
      ansible.builtin.copy:
        dest: "{{ report_path }}"
        content: "{{ _report_md }}"
        mode: "0644"

    #####################################################################
    # Gate / Fail wenn Issues > 0
    #####################################################################
    - name: Fail because issues were found
      ansible.builtin.fail:
        msg: "Maintenance Gate failed: {{ maintenance_issues }} issues. See {{ report_path }}"
      when: maintenance_issues | int > 0
