- name: Samba AD backup (online) with rotation (local + optional rsync)
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../group_vars/all.yml

  # per -e Ã¼berschreibbar, z.B.:
  #  -e 'backup_dir=/backup/samba-ad keep=7 do_rsync=false'
  vars:
    backup_dir: "{{ backup_dir | default('/backup/samba-ad') }}"
    keep: "{{ keep | default(7) }}"
    do_rsync: "{{ do_rsync | default(false) }}"

  tasks:
    # --- 1) Zielverzeichnisse im DC-A vorbereiten ---
    - name: Ensure backup + tmp dir exist on dc_a
      ansible.builtin.shell: |
        pct exec {{ dc_a.ctid }} -- bash -lc '
          set -e
          mkdir -p "{{ backup_dir }}" "{{ backup_dir }}/tmp"
          chown root:root "{{ backup_dir }}" "{{ backup_dir }}/tmp"
          chmod 700 "{{ backup_dir }}"
        '
      changed_when: true

    # --- 2) Online-Backup robust (TMPDIR, ulimit, Kerberos) ---
    - name: Online backup on dc_a (TMP on backup dir; robust env)
      ansible.builtin.shell: |
        pct exec {{ dc_a.ctid }} -- bash -lc '
          set -e
          export KRB5CCNAME=/root/ccache
          export TMPDIR="{{ backup_dir }}/tmp"
          export PYTHONMALLOC=malloc
          ulimit -n 8192
          ulimit -s unlimited

          # Ticket auffrischen (tolerant; wenn bereits vorhanden, ok)
          REALM="$(hostname -d | tr a-z A-Z)"
          kinit -k -t /etc/krb5.keytab "{{ dc_a.hn }}$@${REALM}" || true

          # Online-Backup gegen FQDN des DC-A
          samba-tool domain backup online \
            --server="{{ dc_a.hn }}.amazonistan.intranet" \
            --targetdir "{{ backup_dir }}" \
            --use-krb5-ccache="$KRB5CCNAME"
        '
      register: ad_online
      changed_when: true
      failed_when: false

    # --- 3) Fallback: Offline-Backup (wenn online fehlte) ---
    - name: Fallback to offline backup if online failed (stop/start samba-ad-dc)
      ansible.builtin.shell: |
        pct exec {{ dc_a.ctid }} -- bash -lc '
          set -e
          systemctl stop samba-ad-dc
          samba-tool domain backup offline --targetdir "{{ backup_dir }}"
          systemctl start samba-ad-dc"
        '
      when: ad_online.rc != 0
      changed_when: true

    # --- 4) Rotation: nur die neuesten {{ keep }} Backups behalten ---
    - name: Rotate old backups on dc_a (keep {{ keep }})
      ansible.builtin.shell: >
        pct exec {{ dc_a.ctid }} -- bash -lc
        'set -euo pipefail; KEEP="{{ keep }}"; DIR="{{ backup_dir }}"; ls -1t "$DIR"/samba-backup-*.tar.bz2 2>/dev/null | awk -v k="$KEEP" "NR>k" | xargs -r rm -f --'
      args:
        executable: /bin/bash
      changed_when: true

    # --- 5) Optional: rsync der Backups auf DC-B (nur wenn do_rsync=true) ---
    - name: Optional rsync backups to dc_b (when do_rsync=true)
      ansible.builtin.shell: |
        pct exec {{ dc_a.ctid }} -- bash -lc '
          set -e
          RSYNC_OPTS="-a --delete --numeric-ids"
          rsync $RSYNC_OPTS -e "ssh -o StrictHostKeyChecking=accept-new" \
            "{{ backup_dir }}/" {{ dc_b.ip }}:"{{ backup_dir }}/"
        '
      when: do_rsync | bool
      changed_when: true

    # --- 6) Ausgabe: Zeige das neueste Archiv ---
    - name: Show newest backup file on dc_a
      ansible.builtin.shell: |
        pct exec {{ dc_a.ctid }} -- bash -lc '
          ls -1t "{{ backup_dir }}/"samba-backup-*.tar.bz2 2>/dev/null | head -n1 || true
        '
      register: newest_file
      changed_when: false

    - name: Print newest backup file
      ansible.builtin.debug:
        msg: "Newest backup: {{ newest_file.stdout | default('n/a') }}"
